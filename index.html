<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Casdoor Auth Panel</title>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: 'Segoe UI', sans-serif;
            background: #ffffff;
            color: #222;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: start;
            min-height: 100vh;
            padding: 40px 20px;
        }

        h1 {
            margin-bottom: 2rem;
            color: #000;
            font-size: 2rem;
            text-align: center;
        }

        .action-btn {
            background: #0055cc;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 10px 18px;
            margin: 0 10px 20px;
            font-size: 15px;
            cursor: pointer;
            transition: background 0.2s ease, transform 0.1s ease;
        }

        .action-btn:hover:not(:disabled) {
            background: #1a75ff;
        }

        .action-btn:disabled {
            background: #dddddd;
            color: #777;
            cursor: not-allowed;
        }

        .info-box {
            display: none;
            background: #f9f9f9;
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 20px;
            min-width: 320px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        .info-item {
            margin-bottom: 10px;
            font-size: 15px;
            display: flex;
        }

        .info-item span:first-child {
            font-weight: bold;
            color: #333;
        }

        .info-item span:last-child {
            color: #555;
        }
    </style>
</head>

<body>

    <h1>Casdoor Authentication</h1>

    <div>
        <button id="loginBtn" class="action-btn">Log In</button>
        <button id="infoBtn" class="action-btn">Get Info</button>
        <button id="logoutBtn" class="action-btn">Log Out</button>
    </div>

    <div class="info-box" id="infoBox">
        <div class="info-item"><span>ID:&nbsp;</span><span id="uid">-</span></div>
        <div class="info-item"><span>Name:&nbsp;</span><span id="uname">-</span></div>
        <div class="info-item"><span>Surname:&nbsp;</span><span id="usurname">-</span></div>
        <div class="info-item"><span>Group:&nbsp;</span><span id="ugroup">-</span></div>
    </div>

    <script>
        const API = 'http://localhost:3000';
        let authenticated = false;

        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const infoBtn = document.getElementById('infoBtn');
        const infoBox = document.getElementById('infoBox');

        const setText = (id, value) => document.getElementById(id).textContent = value || 'N/A';

        const toggleButtons = () => {
            loginBtn.disabled = authenticated;
            logoutBtn.disabled = !authenticated;
        };

        const renderUserBlock = ({ userId, name, surname, group }) => {
            setText('uid', userId);
            setText('uname', name);
            setText('usurname', surname);
            setText('ugroup', group);
            infoBox.style.display = 'block';
        };

        const clearUserBlock = () => {
            infoBox.style.display = 'none';
        };

        const fetchUserInfo = async () => {
            if (!authenticated) {
                alert('You must be logged in to view user info.');
                return;
            }

            try {
                const res = await fetch(`${API}/user-info`, { credentials: 'include' });
                if (res.ok) {
                    const data = await res.json();
                    renderUserBlock(data);
                } else {
                    alert('Failed to fetch user info.');
                    clearUserBlock();
                }
            } catch (err) {
                alert('Error fetching user info: ' + err.message);
                clearUserBlock();
            }
        };

        const handleLogin = async () => {
            if (authenticated) return;
            try {
                const res = await fetch(`${API}/login`);
                const { url } = await res.json();
                location.href = url;
            } catch (err) {
                alert('Login failed: ' + err.message);
            }
        };

        const handleLogout = async () => {
            if (!authenticated) return;
            try {
                const res = await fetch(`${API}/logout`, {
                    method: 'POST',
                    credentials: 'include'
                });
                if (res.ok) {
                    authenticated = false;
                    clearUserBlock();
                    toggleButtons();
                } else {
                    alert('Logout error');
                }
            } catch (err) {
                alert('Logout failed: ' + err.message);
            }
        };

        // Перевірка логіну на старті (без показу інфи)
        const checkAuthStatus = async () => {
            try {
                const res = await fetch(`${API}/user-info`, { credentials: 'include' });
                authenticated = res.ok;
            } catch {
                authenticated = false;
            } finally {
                toggleButtons();
            }
        };

        loginBtn.addEventListener('click', handleLogin);
        logoutBtn.addEventListener('click', handleLogout);
        infoBtn.addEventListener('click', fetchUserInfo);
        window.addEventListener('load', checkAuthStatus);
    </script>
</body>

</html>